1.**文件上传漏洞**
------------

### 1.1.文件上传漏洞介绍

文件上传漏洞是指由于程序员在对用户文件上传部分的控制不足或者处理缺陷，而导致的用户可以越过其本身权限向服务器上上传可执行的动态脚本文件。这里上传的文件可以是木马，病毒，恶意脚本或者WebShell等。“文件上传”本身没有问题，有问题的是文件上传后，服务器怎么处理、解释文件。如果服务器的处理逻辑做的不够安全，则会导致严重的后果。（ppt1）

---

#### 了解：什么是webshell

**WebShell就是以asp、php、jsp或者cgi等网页文件形式存在的一种命令执行环境，也可以将其称之为一种网页后门。**攻击者在入侵了一个网站后，通常会将这些asp或php后门文件与网站服务器web目录下正常的网页文件混在一起，然后使用浏览器来访问这些后门，得到一个命令执行环境，以达到控制网站服务器的目的**（可以上传下载或者修改文件，操作数据库，执行任意命令等）。** **WebShell后门隐蔽较性高，可以轻松穿越防火墙，访问WebShell时不会留下系统日志，只会在网站的web日志中留下一些数据提交记录**（选做）

### 1.2.文件上传漏洞危害

1. 上传文件**web脚本**语言，服务器的web容器解释并执行了用户上传的脚本，导致代码**执行**。

2. 上传文件**病毒或者木马**时，主要用于诱骗用户或者管理员下载执行或者直接 自劢运行；

3. 上传文件是**Flash的策略文件 crossdomain.xml**，黑客用以**控制Flash在该域下的行为**(其他通过类似方式控制策略文件的情况类似);

   ```
   crossdomain.xml
   可参考博客
   https://blog.csdn.net/qq_42527761/article/details/107787147)
   https://cn-sec.com/archives/301874.html
   ```

   

4. **上传文件是钓鱼图片或为包含了脚本的图片，在某些版本的浏览器中会被作为脚本执行，被用于钓鱼和欺诈**。 除此之外，还有一些不常见的利用方法，比如将上传文件作为一个入口，溢 出服务器的后台处理程序，如图片解析模块;或者上传一个合法的文本文件，其内容包含了PHP脚本，再通过"本地文件包含漏洞(Local File Include)"执行此脚本。



#### 产生文件上传漏洞的原因（ppt2）

> **原因：**
>
> *   对于上传文件的后缀名（扩展名）没有做较为严格的限制
> *   对于上传文件的MIMETYPE(用于描述文件的类型的一种表述方法) 没有做检查
> *   权限上没有对于上传的文件目录设置不可执行权限
> *   对于web server对于上传文件或者指定目录的行为没有做限制



#### 文件上传漏洞的攻击与防御方式（pptn）

##### 1.前端限制

##### 2.检查扩展名（黑白名单策略）

##### 3.检查Content-Type

##### 4.文件头检查文件

##### 5.限制Web Server对特定类型文件的行为

##### **6.文件系统00截断**

##### **7.windows NTFS文件系统特性绕过**

##### **8.二次渲染绕过**

##### **9.条件竞争**

##### **10.其它—绕过**



### 1.3.靶场示例

根据上面的攻击方式挑几个典型的进行相关靶场讲解：

1. ##### **MIME检查Content-Type**

服务端MIME类型检测是通过检查http中包含的Content-Type字段中的值来判断上传文件是否合法的。

* 利用Burp抓包，将报文中的Content-Type改成允许的类型(上传a.php)

>                Content-Type: image/gif（gif图像）
>                Content-Type: image/jpg（jpg图像）
>                Content-Type: image/png（png图像）
>
>        ![](https://img-blog.csdnimg.cn/direct/7a1cb0d5fef74a9f872fccfe72d843c6.png)
>
>        通过抓包可以发现这里的文件类型为默认参数，而我们这种情况上传文件肯定是上传不上去的，

修改：

![屏幕截图 2024-05-12 160512](https://starofeden-blog.oss-cn-chengdu.aliyuncs.com/img/202405121608074.png)

2. **黑名单**

特殊解析后缀绕过是由于黑名单过滤规则不严谨，在某些特定的情况下的后缀也能够被当作php文件进行解析，例如PHP2、php3、php4、phtml、pht等情况。

可以使用phtml、php3、php4、php5，当然前提是apache服务器，同时在配置文件夹中需要有将AddType application/x-httpd-php .php .phtml .phps .php1 .php4 .pht 这样的一段话前面的注释删除，重启phpstudy让其生效。

![](https://img-blog.csdnimg.cn/direct/41e76da42d854e54bd4211ad5bc6a717.png)

**upload-labs第三关**

分析源码发现本关禁止.asp、.aspx、.php、.jsp类型进行上传。

![image-20240514203536749](C:\Users\Annie\AppData\Roaming\Typora\typora-user-images\image-20240514203536749.png)

本关可以通过上传其他文件扩展名进行绕过，实现文件上传。

这里提示上传一张图片

![](https://img-blog.csdnimg.cn/direct/70443f2a082c4dc0885a337e112accfb.png)

那就上传一张"图",他说不能上传这几个类型，那我改个名不就好了，

![](https://img-blog.csdnimg.cn/direct/9786fcf0528948988c7757fb6e9b88c7.png)

上传成功！

与之同理的还有

```
.htaccess绕过：  （适用于非nts的php版本）
上传.htaccess 文件再上传a.jpg，修改.htaccess文件的参数就可以把jpg文件解析成php，从而成功上传
```

3. %00截断

   #### 基本概念

   当 PHP 在处理文件名或路径时，如果遇到 URL 编码的 %00，它会被解释为一个空字节（ASCII 值为 0）。在php5.3以前，PHP 会将这个空字节转换为 \\000 的形式。

   而恰恰在php5.3以前，文件名出现\\0000,会导致文件名被截断，只保留%00之前的部分。这样的情况可能会导致文件被保存到一个意外的位置，从而产生安全风险

   这是因为php语言的底层是c语言，而\\0在c语言中是字符串的结束符，所以导致00截断的发生

   #### upload-labs第十一关

   通过源码发现本关是个白名单，但是可以使用%00对路径进行截断。

   <img src="https://img-blog.csdnimg.cn/direct/bd1d46079e314e609b06a463496e2bd6.png" style="zoom:200%;" />

   我们可以看到**img\_path（图片路径）是通过get传参传递的**（见上图），那么我们不妨在这块将路径改掉，改为upload/web.php%00，那么后面不管是什么东西都会被截断掉，然后经过move\_uploaded\_file函数将临时文件重新复制给我们的截断之前的文件路径，当然，我们还是要上传jpg文件的，使得我们可以进行下面程序的运行

   ![](https://img-blog.csdnimg.cn/direct/eb0dfce449004d2ebd978e0c93044b28.png)

### 1.4.文件检测流程（可不讲）

通常一个文件以HTTP协议进行上传时，将以POST请求发送至web服务器，web服务器接收到请求后并同意后，用户与web 服务器将建立连接，并传输data：

 而一般一个文件上传过程中的检测内容如下部分：

客户端 javascript 检测 (通常为检测文件扩展名)  
服务端 MIME 类型检测 (检测 Content-Type 内容)  
服务端目录路径检测 (检测跟 path 参数相关的内容)  
服务端文件扩展名检测 (检测跟文件 extension 相关的内容)  
服务端文件内容检测 (检测内容是否合法或含有恶意代码)

